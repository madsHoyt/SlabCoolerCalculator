<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cooldown Calculator</title>
        <script
            src="https://kit.fontawesome.com/144a64cf0a.js"
            crossorigin="anonymous"
        ></script>

        <link rel="stylesheet" href="styles.css" />
        <link rel="icon" href="favicon.ico" type="image/x-icon" />
        <!--Chart.js-->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Cooler Calculator</h1>
                <p>Multi-Layer Cooldown Time Calculator</p>
            </div>

            <div class="content">
                <div class="section">
                    <h2>Temperature Parameters</h2>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Initial Temperature (°C)</label>
                            <input
                                type="number"
                                id="initialTemp"
                                value="73.8889"
                                step="0.1"
                            />
                        </div>
                        <div class="input-field">
                            <label>Ambient Temperature (°C)</label>
                            <input
                                type="number"
                                id="ambientTemp"
                                value="7.22222"
                                step="0.1"
                            />
                        </div>
                        <div class="input-field">
                            <label>Final Temperature (°C)</label>
                            <input
                                type="number"
                                id="finalTemp"
                                value="7.92222"
                                step="0.1"
                            />
                        </div>
                        <div class="input-field">
                            <label>Heat Transfer Coefficient (W/m²/K)</label>
                            <input
                                type="number"
                                id="heatCoef"
                                value="100"
                                step="1"
                            />
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Pipe Layers</h2>
                    <div id="layersContainer">
                        <div class="layer" data-layer="0">
                            <h3>Layer 0</h3>
                            <div class="input-group">
                                <div class="input-field">
                                    <label>Length (m)</label>
                                    <input
                                        type="number"
                                        class="diameter"
                                        value="0.15"
                                        step="0.001"
                                    />
                                </div>
                                <div class="input-field">
                                    <label>Conductivity (W/m/K)</label>
                                    <input
                                        type="number"
                                        class="conductivity"
                                        value="1"
                                        step="0.001"
                                    />
                                </div>
                                <div class="input-field">
                                    <label>Density (kg/m³)</label>
                                    <input
                                        type="number"
                                        class="density"
                                        value="1000"
                                        step="1"
                                    />
                                </div>
                                <div class="input-field">
                                    <label>Heat Capacity (J/kg/K)</label>
                                    <input
                                        type="number"
                                        class="heatCapacity"
                                        value="4180"
                                        step="1"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="layer" data-layer="1">
                            <h3>Layer 1</h3>
                            <div class="input-group">
                                <div class="input-field">
                                    <label>Length (m)</label>
                                    <input
                                        type="number"
                                        class="diameter"
                                        value="0.18"
                                        step="0.001"
                                    />
                                </div>
                                <div class="input-field">
                                    <label>Conductivity (W/m/K)</label>
                                    <input
                                        type="number"
                                        class="conductivity"
                                        value="45"
                                        step="0.001"
                                    />
                                </div>
                                <div class="input-field">
                                    <label>Density (kg/m³)</label>
                                    <input
                                        type="number"
                                        class="density"
                                        value="7800"
                                        step="1"
                                    />
                                </div>
                                <div class="input-field">
                                    <label>Heat Capacity (J/kg/K)</label>
                                    <input
                                        type="number"
                                        class="heatCapacity"
                                        value="450"
                                        step="1"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="buttons">
                        <button class="add-layer-btn" onclick="addLayer()">
                            + Add Layer
                        </button>
                    </div>
                </div>

                <div class="buttons">
                    <button class="calculate-btn" onclick="startCalculation()">
                        Calculate Cooldown Time
                    </button>
                </div>

                <div class="loading" id="loading">
                    <div class="dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>

                <div class="results" id="results">
                    <h2>Results</h2>
                    <div>
                        <strong>Cooldown Time:</strong>
                        <div class="result-value" id="cooldownTime">--</div>
                    </div>
                    <details>
                        <summary
                            style="
                                cursor: pointer;
                                font-weight: 600;
                                margin-bottom: 10px;
                            "
                        >
                            View Detailed Output
                        </summary>
                        <div class="output-data" id="detailedOutput"></div>
                    </details>
                    <br />
                    <button
                        id="downloadBtn"
                        class="calculate-btn"
                        style="display: none"
                        onclick="downloadOutput()"
                    >
                        Download Results
                    </button>
                    <h2 class="sub-head">Temperature Graphs</h2>
                    <canvas
                        id="timeGraph"
                        width="800"
                        height="400"
                        style="margin-top: 20px; background-color: white"
                    ></canvas>
                    <canvas
                        id="radiusGraph"
                        width="800"
                        height="400"
                        style="margin-top: 20px; background-color: white"
                    ></canvas>
                </div>
                <div>
                    <br />
                    <p>
                        <b>Notice:</b> Adapted for a slab from Benjamin DEGLO DE
                        BESSES' pipe cooldt calculator.
                    </p>
                </div>
            </div>
        </div>

        <!-- Load the compiled WebAssembly module -->
        <script src="cooldt.js"></script>

        <script>
            let layerCount = 2;
            let Module = null;

            // --- Load the WebAssembly module ---
            CoolDTModule({
                print: function (text) {
                    console.log("WASM stdout:", text);
                },
                printErr: function (text) {
                    console.error("WASM stderr:", text);
                },
            })
                .then(function (module) {
                    Module = module;
                    console.log(
                        "CoolDT WebAssembly module loaded successfully!"
                    );
                    document.querySelector(".calculate-btn").disabled = false;
                })
                .catch(function (err) {
                    console.error("Failed to load WASM module:", err);
                    alert(
                        "Failed to load calculation engine. Please refresh the page."
                    );
                });

            // --- Layer management ---
            function addLayer() {
                if (layerCount >= 19) {
                    alert("Maximum 19 layers allowed");
                    return;
                }
                const container = document.getElementById("layersContainer");
                const newLayer = document.createElement("div");
                newLayer.className = "layer";
                newLayer.setAttribute("data-layer", layerCount);
                newLayer.innerHTML = `
        <div class="layer-header">
            <h3>Layer ${layerCount}</h3>
            <button class="delete-layer-btn" onclick="deleteLayer(this)"><b>X</b></button>
        </div>
        <div class="input-group">
            <div class="input-field">
                <label>Length (m)</label>
                <input type="number" class="diameter" value="0.28" step="0.001">
            </div>
            <div class="input-field">
                <label>Conductivity (W/m/K)</label>
                <input type="number" class="conductivity" value="0.3" step="0.001">
            </div>
            <div class="input-field">
                <label>Density (kg/m³)</label>
                <input type="number" class="density" value="800" step="1">
            </div>
            <div class="input-field">
                <label>Heat Capacity (J/kg/K)</label>
                <input type="number" class="heatCapacity" value="2000" step="1">
            </div>
        </div>
    `;
                container.appendChild(newLayer);
                layerCount++;
            }

            function deleteLayer(button) {
                const layer = button.closest(".layer");
                layer.remove();
            }

            function generateInputData() {
                const initialTemp =
                    document.getElementById("initialTemp").value;
                const ambientTemp =
                    document.getElementById("ambientTemp").value;
                const finalTemp = document.getElementById("finalTemp").value;
                const heatCoef = document.getElementById("heatCoef").value;

                let inputData = `${initialTemp}\t${ambientTemp}\t${finalTemp}\t${heatCoef}\n`;

                const layers = document.querySelectorAll(".layer");
                layers.forEach((layer) => {
                    const diameter = layer.querySelector(".diameter").value;
                    const conductivity =
                        layer.querySelector(".conductivity").value;
                    const density = layer.querySelector(".density").value;
                    const heatCapacity =
                        layer.querySelector(".heatCapacity").value;
                    inputData += `${diameter}\t${conductivity}\t${density}\t${heatCapacity}\n`;
                });

                return inputData;
            }

            // --- Calculation ---
            function startCalculation() {
                const loadingEl = document.getElementById("loading");
                loadingEl.style.display = "block";

                if (!Module) {
                    alert(
                        "WebAssembly module is still loading. Please wait..."
                    );
                    loadingEl.style.display = "none";
                    return;
                }

                // Let the browser render the loader
                setTimeout(() => {
                    calculate();
                }, 50);
            }

            function calculate() {
                const loadingEl = document.getElementById("loading");
                const inputData = generateInputData();

                try {
                    Module.FS.writeFile("input.dat", inputData);

                    let stdout = "",
                        stderr = "";
                    Module.print = (text) => (stdout += text + "\n");
                    Module.printErr = (text) => (stderr += text + "\n");

                    // Call the main function
                    Module.callMain(["input.dat"]);

                    let outputData = "";
                    try {
                        outputData = Module.FS.readFile("input.txt", {
                            encoding: "utf8",
                        });
                    } catch (e) {
                        console.error("Could not read output file:", e);
                        outputData =
                            "Output file not generated. Check console for errors.\n\n" +
                            stderr;
                    }

                    displayResults(outputData);

                    // Cleanup
                    try {
                        Module.FS.unlink("input.dat");
                        Module.FS.unlink("input.txt");
                    } catch (e) {}

                    loadingEl.style.display = "none";
                } catch (error) {
                    console.error("Calculation error:", error);
                    loadingEl.style.display = "none";
                    alert("Calculation failed: " + error.message);
                }
            }

            function plotGraphs(outputData) {
                const lines = outputData.split("\n");

                const time = [];
                const tempSolid = [];
                const radius = [];
                const initialTemp = [];
                const finalTemp = [];

                lines.forEach((line) => {
                    if (line.startsWith("#") || line.trim() === "") return;
                    const parts = line.trim().split(/\s+/);
                    if (parts.length >= 9) {
                        time.push(parseFloat(parts[1])); // t(h)
                        tempSolid.push(parseFloat(parts[2])); // Temp(solid)
                        radius.push(parseFloat(parts[5])); // Half-Length (m)
                        initialTemp.push(parseFloat(parts[7])); // Initial Temp
                        finalTemp.push(parseFloat(parts[8])); // Final Temp
                    }
                });

                // --- Time vs Solid Temp ---
                const ctxTime = document
                    .getElementById("timeGraph")
                    .getContext("2d");
                if (window.timeChart) window.timeChart.destroy();

                window.timeChart = new Chart(ctxTime, {
                    type: "line",
                    data: {
                        labels: time,
                        datasets: [
                            {
                                label: "Solid Temp (°C)",
                                data: tempSolid,
                                borderColor: "darkgreen",
                                backgroundColor: "rgba(0,128,0,0.1)",
                                fill: true,
                                tension: 0.3,
                                pointRadius: 2,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: "Time vs Solid Temperature",
                            },
                        },
                        scales: {
                            x: { title: { display: true, text: "Time (h)" } },
                            y: {
                                title: {
                                    display: true,
                                    text: "Temperature (°C)",
                                },
                            },
                        },
                    },
                });

                // --- Radius vs Initial/Final Temp ---
                const ctxRadius = document
                    .getElementById("radiusGraph")
                    .getContext("2d");
                if (window.radiusChart) window.radiusChart.destroy();

                window.radiusChart = new Chart(ctxRadius, {
                    type: "line",
                    data: {
                        labels: radius,
                        datasets: [
                            {
                                label: "Initial Temp (°C)",
                                data: initialTemp,
                                borderColor: "orange",
                                backgroundColor: "rgba(255,165,0,0.1)",
                                fill: false,
                                tension: 0.3,
                                pointRadius: 2,
                            },
                            {
                                label: "Final Temp (°C)",
                                data: finalTemp,
                                borderColor: "blue",
                                backgroundColor: "rgba(0,0,255,0.1)",
                                fill: false,
                                tension: 0.3,
                                pointRadius: 2,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: "Radius vs Initial/Final Temperature",
                            },
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "Half-Length (m)",
                                },
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: "Temperature (°C)",
                                },
                            },
                        },
                    },
                });
            }

            function displayResults(outputData) {
                const cooldownMatch = outputData.match(
                    /Cool Down Time\s+([0-9.]+)\s+\(h\)/
                );
                const cooldownTime = cooldownMatch ? cooldownMatch[1] : "N/A";

                document.getElementById("cooldownTime").textContent =
                    cooldownTime + " hours";
                document.getElementById("detailedOutput").textContent =
                    outputData;
                document.getElementById("results").classList.add("show");
                document.getElementById("downloadBtn").style.display =
                    "inline-block";

                // Let the browser repaint to show loader before heavy plotting
                setTimeout(() => {
                    plotGraphs(outputData);
                    document.getElementById("loading").style.display = "none";
                }, 20);
            }

            // --- Download ---
            function downloadOutput() {
                const data =
                    document.getElementById("detailedOutput").textContent;
                if (!data) {
                    alert("No data to download yet!");
                    return;
                }

                const csvData = data.replace(/\t/g, ",");
                const blob = new Blob([csvData], { type: "text/csv" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "cooldown_results.csv";
                link.click();
                URL.revokeObjectURL(link.href);
            }
        </script>
    </body>
</html>
